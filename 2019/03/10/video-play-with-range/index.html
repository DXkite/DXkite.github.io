<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd">
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  
  
  <title>  视频播放、断点续传、多线程下载实现基础：Range |   Hello! I am DXkite </title>

 
  
    <link rel="icon" href="/favicon.png">
  


  <link rel="stylesheet" href="/nayo.min.css"> 
</head>
<style>
  .alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
  }

  .alert {
    position: relative;
    padding: .75rem 1.25rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
    border-radius: .25rem;
    box-sizing: border-box;
  }
</style>

<body>

  <header class="header">
	
  <nav class="header-nav">        
   
    <span class="iconfont icon-menu mobile-toggle"></span>   	

    <div class="header-menu">          
              
            

              <a class="header-menu-link" id="header-menu-home" href="/">首页</a>     

            
            
            

              <a class="header-menu-link" id="header-menu-archives" href="/archives">归档</a>     

            
            
            

              <a class="header-menu-link" id="header-menu-tags" href="/tags">标签</a>     

            
            
            

              <a class="header-menu-link" id="header-menu-about" href="/about">关于</a>     

            
            
            

              <a class="header-menu-link" id="header-menu-suda" href="/suda">Suda</a>     

            
            
            

              <a class="header-menu-link" id="header-menu-suda-manual" href="/suda-manual">Suda手册</a>     

            
            
            

              <a class="iconfont icon-menu-search header-menu-link" id="header-menu-search"></a>

            
                
    </div>  
    
  </nav>
</header>


  
  <div class="container">
   
    
    <section class="main">
      
        
          <a href="http://www.atd3.cn">
            <div class="alert alert-success">点我访问博客临时新地址！文章基本发布在这里，年后备案之后换回来</div>
          </a>
        
        <article class="post">
  
	<div class="post-header">

	<p class="post-title">	
		视频播放、断点续传、多线程下载实现基础：Range
	</p>
			

	<div class="meta-info">	
	<span>
		3月 10, 2019
	</span>

	
	
		<i class="iconfont icon-words"></i>
		<span>
			7703
		</span>
	
</div>

</div> 
	 

	  <div class="post-content slideDownMin">

		

			
					<p>实现一个视频播放的功能，以及对大文件的下载操作等等都避不开一个点：获取文件任意位置的数据，如果说我们单纯的通过 <code>echo file-content</code> 的方式只能用于文件下载，如果视频文件用于播放中，则难以处理，具体表现则为视频播放的时候无法调整进度条，而且如果是视频网站，对于视频只采用放在某个可以直接访问的目录上，那么这个视频也就相当于公开了，对于什么 <code>VIP</code> 什么的也就无从说起，本篇文章将 <code>Range</code>，来提供视频播放、断点续传、多线程下载的技术依赖实现 </p>
<a id="more"></a>
<h2 id="Range"><a href="#Range" class="headerlink" title="Range"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Range" target="_blank" rel="noopener">Range</a></h2><p>HTTP协议中，支持以 <code>Range</code> 的形式指定获取资源的特定偏移的数据，语法格式如下，具体参考 <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Range" target="_blank" rel="noopener">Range: MDN</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-</span><br><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;</span><br><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;</span><br><span class="line">Range: &lt;unit&gt;=&lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;, &lt;range-start&gt;-&lt;range-end&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>&lt;unit&gt;</code> 只能是 <code>bytes</code> （目前来说），指定单位</li>
<li><code>&lt;range-start&gt;</code> 一个整数，表示在特定单位下，范围的起始值。</li>
<li><code>&lt;range-end&gt;</code> 一个整数，表示在特定单位下，范围的结束值。这个值是可选的，如果不存在，表示此范围一直延伸到文档结束。</li>
</ul>
<p>如： 获取 <code>0-100</code> 字节的数据和120到结尾的数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Range: bytes=0-100,120-</span><br></pre></td></tr></table></figure>
<h2 id="Content-Range"><a href="#Content-Range" class="headerlink" title="Content-Range"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Range" target="_blank" rel="noopener">Content-Range</a></h2><p>该头部指定了响应的数据的内容范围，语法格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Content-Range: &lt;unit&gt; &lt;range-start&gt;-&lt;range-end&gt;/&lt;size&gt;</span><br><span class="line">Content-Range: &lt;unit&gt; &lt;range-start&gt;-&lt;range-end&gt;/*</span><br><span class="line">Content-Range: &lt;unit&gt; */&lt;size&gt;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li><code>&lt;unit&gt;</code> 数据区间所采用的单位。通常是字节（bytes）。</li>
<li><code>&lt;range-start&gt;</code> 一个整数，表示在给定单位下，区间的起始值。</li>
<li><code>&lt;range-end&gt;</code> 一个整数，表示在给定单位下，区间的结束值。</li>
<li><code>&lt;size&gt;</code> 整个文件的大小（如果大小未知则用 <code>&quot;*&quot;</code> 表示）</li>
</ul>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Range: bytes 200-1000/67589</span><br></pre></td></tr></table></figure>
<h3 id="多Range响应"><a href="#多Range响应" class="headerlink" title="多Range响应"></a>多Range响应</h3><p>目测在网络上面的都没有说到，但是HTTP协议支持多Range，具体返回内容信息格式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">GET http://suda.dev.dx/file HTTP/1.1</span><br><span class="line">Host: suda.dev.dx</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Accept-Encoding: identity;q=1, *;q=0</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/73.0.3679.0 Safari/537.36</span><br><span class="line">Accept: */*</span><br><span class="line">Referer: http://test.dev.dx/video.html</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: php_session=8eec314af63d994c2eeb1baca7487332</span><br><span class="line">Range: bytes=0-1,2-3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HTTP/1.1 206 Partial Content</span><br><span class="line">Date: Sun, 10 Mar 2019 09:36:59 GMT</span><br><span class="line">Server: Apache/2.4.23 (Win32) OpenSSL/1.0.2j mod_fcgid/2.3.9</span><br><span class="line">X-Powered-By: PHP/7.2.1</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">Content-Length: 220</span><br><span class="line">Keep-Alive: timeout=5, max=100</span><br><span class="line">Connection: Keep-Alive</span><br><span class="line">Content-Type: multipart/byteranges; boundary=multiple_range_ss6bBSB6IlLi0YPpP8rK3g==</span><br><span class="line"></span><br><span class="line">--multiple_range_ss6bBSB6IlLi0YPpP8rK3g==</span><br><span class="line">Content-Type: video/mp4</span><br><span class="line">Content-Range: bytes 0-1/132006090</span><br><span class="line"></span><br><span class="line">&lt;...somedata...&gt;</span><br><span class="line">--multiple_range_ss6bBSB6IlLi0YPpP8rK3g==</span><br><span class="line">Content-Type: video/mp4</span><br><span class="line">Content-Range: bytes 2-3/132006090</span><br><span class="line"></span><br><span class="line">&lt;...somedata...&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Accept-Rangs"><a href="#Accept-Rangs" class="headerlink" title="Accept-Rangs"></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Ranges" target="_blank" rel="noopener">Accept-Rangs</a></h2><p>服务器响应，告诉浏览器是否支持 <code>Range</code>,</p>
<p>语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Accept-Ranges: bytes</span><br><span class="line">Accept-Ranges: none</span><br></pre></td></tr></table></figure>
<ul>
<li>none<br>  不支持任何范围请求单位，由于其等同于没有返回此头部，因此很少使用。不过一些浏览器，比如IE9，会依据该头部去禁用或者移除下载管理器的暂停按钮。</li>
<li>bytes<br>  范围请求的单位是 bytes （字节）</li>
</ul>
<h2 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h2><p>本实现代码可以简单理解为伪代码，部分依赖没有给出，<code>Swoole</code> 环境下修改一下即可使用。</p>
<h3 id="使用代码"><a href="#使用代码" class="headerlink" title="使用代码:"></a>使用代码:</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">suda</span>\<span class="title">welcome</span>\<span class="title">response</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">framework</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">framework</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">application</span>\<span class="title">processor</span>\<span class="title">RequestProcessor</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">application</span>\<span class="title">processor</span>\<span class="title">FileRangeProccessor</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileResponse</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(Request $request, Response $response)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $filename = <span class="string">'G:\视频\刺客伍六七.2018\EP01.mp4'</span>;</span><br><span class="line">        $processor = <span class="keyword">new</span> FileRangeProccessor($filename);</span><br><span class="line">        $processor-&gt;onRequest($request, $response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="依赖代码"><a href="#依赖代码" class="headerlink" title="依赖代码:"></a>依赖代码:</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">suda</span>\<span class="title">application</span>\<span class="title">processor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">SplFileObject</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">framework</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">framework</span>\<span class="title">Response</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">framework</span>\<span class="title">response</span>\<span class="title">MimeType</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">framework</span>\<span class="title">http</span>\<span class="title">stream</span>\<span class="title">DataStream</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">suda</span>\<span class="title">application</span>\<span class="title">processor</span>\<span class="title">RequestProcessor</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 响应</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileRangeProccessor</span> <span class="keyword">implements</span> <span class="title">RequestProcessor</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 文件路径</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> SplFileObject</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $file;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * MIME</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $mime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($file)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = $file <span class="keyword">instanceof</span> SplFileObject? $file : <span class="keyword">new</span> SplFileObject($file);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;mime = MimeType::getMimeType(<span class="keyword">$this</span>-&gt;file-&gt;getExtension());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理文件请求</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \suda\framework\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \suda\framework\Response $response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onRequest</span><span class="params">(Request $request, Response $response)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ranges = <span class="keyword">$this</span>-&gt;getRanges($request);</span><br><span class="line">        $response-&gt;setHeader(<span class="string">'accept-ranges'</span>, <span class="string">'bytes'</span>);</span><br><span class="line">        <span class="keyword">if</span> ($ranges === <span class="keyword">false</span> || $request-&gt;getMethod() !== <span class="string">'GET'</span>) &#123;</span><br><span class="line">            $response-&gt;status(<span class="number">400</span>);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($ranges === <span class="keyword">null</span>) &#123;</span><br><span class="line">            $response-&gt;sendFile(<span class="keyword">$this</span>-&gt;file-&gt;getRealPath());</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (count($ranges) === <span class="number">1</span>) &#123;</span><br><span class="line">            $response-&gt;status(<span class="number">206</span>);</span><br><span class="line">            $range = $ranges[<span class="number">0</span>];</span><br><span class="line">            $response-&gt;setHeader(<span class="string">'content-type'</span>, <span class="keyword">$this</span>-&gt;mime);</span><br><span class="line">            $response-&gt;setHeader(<span class="string">'content-range'</span>, <span class="keyword">$this</span>-&gt;getRangeHeader($range));</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sendFileByRange($response, $range);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $response-&gt;status(<span class="number">206</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sendMultipleFileByRange($response, $ranges);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送多Range</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \suda\framework\Response $response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $ranges</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMultipleFileByRange</span><span class="params">(Response $response, array $ranges)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $separates = <span class="string">'multiple_range_'</span>.base64_encode(\md5(\uniqid(), <span class="keyword">true</span>));</span><br><span class="line">        $response-&gt;setHeader(<span class="string">'content-type'</span>, <span class="string">'multipart/byteranges; boundary='</span>.$separates);</span><br><span class="line">        <span class="keyword">foreach</span> ($ranges <span class="keyword">as</span> $range) &#123;</span><br><span class="line">            $response-&gt;write(<span class="string">'--'</span>.$separates.<span class="string">"\r\n"</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sendMultipleRangePart($response, $range);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;sendFileByRange($response, $range);</span><br><span class="line">            $response-&gt;write(<span class="string">"\r\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送范围数据</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \suda\framework\Response $response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $range</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendFileByRange</span><span class="params">(Response $response, array $range)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response-&gt;write(<span class="keyword">new</span> DataStream(<span class="keyword">$this</span>-&gt;file-&gt;getRealPath(), $range[<span class="string">'start'</span>], $range[<span class="string">'end'</span>] -  $range[<span class="string">'start'</span>] + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Range描述</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \suda\framework\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|bool|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRanges</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $ranges = <span class="keyword">$this</span>-&gt;parseRangeHeader($request);</span><br><span class="line">        <span class="keyword">if</span> (\is_array($ranges)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;parseRanges($ranges);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($ranges === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 写Range头</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \suda\framework\Response $response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $range</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMultipleRangePart</span><span class="params">(Response $response, array $range)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $response-&gt;write(<span class="string">'Content-Type: '</span>.<span class="keyword">$this</span>-&gt;mime.<span class="string">"\r\n"</span>);</span><br><span class="line">        $response-&gt;write(<span class="string">'Content-Range: '</span>.<span class="keyword">$this</span>-&gt;getRangeHeader($range) .<span class="string">"\r\n\r\n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成Range头</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $range</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getRangeHeader</span><span class="params">(array $range)</span>:<span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> sprintf(<span class="string">'bytes %d-%d/%d'</span>, $range[<span class="string">'start'</span>], $range[<span class="string">'end'</span>], <span class="keyword">$this</span>-&gt;file-&gt;getSize());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取Range描述</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> \suda\framework\Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|bool|null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseRangeHeader</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $range = $request-&gt;getHeader(<span class="string">'range'</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (is_string($range)) &#123;</span><br><span class="line">            $range = trim($range);</span><br><span class="line">            <span class="keyword">if</span> (\strpos($range, <span class="string">'bytes='</span>) !== <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            $rangesFrom = \substr($range, strlen(<span class="string">'bytes='</span>));</span><br><span class="line">            <span class="keyword">return</span> \explode(<span class="string">','</span>, $rangesFrom);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理范围</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> array $ranges</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseRanges</span><span class="params">(array $ranges)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $range = [];</span><br><span class="line">        <span class="keyword">foreach</span> ($ranges <span class="keyword">as</span>  $value) &#123;</span><br><span class="line">            <span class="keyword">if</span> (($r = <span class="keyword">$this</span>-&gt;parseRange($value)) !== <span class="keyword">null</span>) &#123;</span><br><span class="line">                $range[] = $r;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $range;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理Range</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> string $range</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">parseRange</span><span class="params">(string $range)</span>:?<span class="title">array</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $range = trim($range);</span><br><span class="line">        <span class="keyword">if</span> (strrpos($range, <span class="string">'-'</span>) === strlen($range) - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> [</span><br><span class="line">                <span class="string">'start'</span> =&gt; intval(\rtrim($range, <span class="string">'-'</span>)),</span><br><span class="line">                <span class="string">'end'</span> =&gt; <span class="keyword">$this</span>-&gt;file-&gt;getSize() - <span class="number">1</span>,</span><br><span class="line">            ];</span><br><span class="line">        &#125; <span class="keyword">elseif</span> (\strpos($range, <span class="string">'-'</span>) !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">list</span>($start, $end) = \explode(<span class="string">'-'</span>, $range, <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">return</span> [<span class="string">'start'</span> =&gt; intval($start) , <span class="string">'end'</span> =&gt; intval($end) ];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ol>
<li><a href="https://tools.ietf.org/html/rfc7233#section-4" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc7233#section-4</a></li>
<li><a href="https://tools.ietf.org/html/rfc7233#section-3" target="_blank" rel="noopener">https://tools.ietf.org/html/rfc7233#section-3</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Ranges" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Accept-Ranges</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Range" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Range</a></li>
<li><a href="https://github.com/dxkite/suda/blob/v3.0/suda/src/application/processor/FileRangeProccessor.php" target="_blank" rel="noopener">完整代码</a></li>
</ol>
  	
					
	  </div>     
	  

	
<div class="post-meta">
      
        <i class="iconfont icon-category"></i>       
        <a class="category-link" href="/categories/技术分享/">技术分享</a> 	
     
      	

      
        <i class="iconfont icon-tag"></i>     
          <a class="tag-link" href="/tags/PHP/">PHP</a> <a class="tag-link" href="/tags/Range/">Range</a>    
      	
</div>





<div class="post-footer">
  <div class="pf-left">
      <img class="pf-avatar" src="/dxkite.png">
      <p class="pf-des">Hello! I am DXkite</p>
  </div>

  <div class="pf-right">           
      <div class="pf-links">
        




<span class="donate-btn">
	<span class="iconfont icon-donate"></span>
</span>


<div id="donate-box" class="sildeUpMin">

	<span class="donate-cancel iconfont icon-cancel"></span>

	<div class="donate-img-box">
		<img id="donate-qr-wechat" class="noLazyLoad donate-img" src="/donate_wechat.png" alt="No Donate Image!">	
		<img id="donate-qr-alipay" class="noLazyLoad donate-img" src="/donate_alipay.jpg" alt="No Donate Image!">	
	</div>

	<span class="donate-word">Hello ! I'am DXkite</span>

	<div class="donate-list">
		<span class="iconfont icon-donate-wechat"></span>
		<span class="iconfont icon-donate-alipay"></span>
	</div>

</div>

 
        
	
<script id="-mob-share" src="http://f1.webshare.mob.com/code/mob-share.js?appkey=21d601593a1de"></script>
	
	<span class="share-btn">
	<span class="iconfont icon-share"></span>
	</span>


	<div class="-mob-share sildeUpMin">
		   			             
            <a class="iconfont  icon-share-qq -mob-share-qq"></a>		
     	   			             
            <a class="iconfont  icon-share-weixin -mob-share-weixin"></a>		
     	   			             
            <a class="iconfont  icon-share-weibo -mob-share-weibo"></a>		
     	   			             
            <a class="iconfont  icon-share-douban -mob-share-douban"></a>		
     	   			             
            <a class="iconfont  icon-share-facebook -mob-share-facebook"></a>		
     	   			             
            <a class="iconfont  icon-share-twitter -mob-share-twitter"></a>		
     	   			             
            <a class="iconfont  icon-share-google -mob-share-google"></a>		
     	   
	</div>	

      </div>  
    <nav class="pf-paginator">
           
        
      
        
        <a href="/2019/02/01/server-side-access-control/" data-hover="服务器端访问控制（CORS）"> 下一篇</a>
            
  </nav>   
  </div>
</div> 
	
	
</article>

      </section>
  </div>

  <a id="backTop">
    <span>
      <i class="iconfont icon-backtotop"></i>
    </span>
  </a>


  
    <div class="search-container sildeUpMin">
        <div class="search-header">
            <input type="text" placeholder="输入你想搜索的" id="search-input" class="search-input">  
            <span class="search-cancel iconfont icon-cancel"></span>
        </div>
        <div id="search-result" class="search-result"></div>
    </div>
 
   <div class="mobile-menu">      

      
      <img class="mobile-menu-icon" src="/favicon.png">   
      

         
            

            <a class="mobile-menu-link" href="/">首页
            </a>
            
         
            

            <a class="mobile-menu-link" href="/archives">归档
            </a>
            
         
            

            <a class="mobile-menu-link" href="/tags">标签
            </a>
            
         
            

            <a class="mobile-menu-link" href="/about">关于
            </a>
            
         
            

            <a class="mobile-menu-link" href="/suda">Suda
            </a>
            
         
            

            <a class="mobile-menu-link" href="/suda-manual">Suda手册
            </a>
            
         
                          

            <a class="mobile-menu-link mobile-menu-search" href="#">搜索 </a>                 
            
         
      
</div>
  


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d7aee75a7326ba3e59244e2db26823c8"; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>






  




<footer id="footer">	    

		
		<div class="footer-copyright">
		&copy;
				
		2018-
		
		2019		
	
		DXkite
		<br>

		Theme By
		<a href="https://github.com/Lemonreds/hexo-theme-Nayo" target="_blank">Nayo</a>	
		</div>			
	 
</footer>



  <script src="/nayo.bundle.js"></script>
</body>

</html>